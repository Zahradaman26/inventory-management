<div class="dashboard-main-body">
    <app-breadcrumb [title]="title"></app-breadcrumb>

    <!-- Success/Error Alerts -->
    <div *ngIf="showSuccess" class="alert alert-success alert-dismissible fade show" role="alert">
        {{ respMessage }}
        <button type="button" class="btn-close" (click)="showSuccess = false"></button>
    </div>
    
    <div *ngIf="showError" class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ respMessage }}
        <button type="button" class="btn-close" (click)="showError = false"></button>
    </div>

    <div class="card basic-data-table">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table bordered-table mb-0" id="dataTable" data-page-length="10">
                    <thead>
                        <tr>
                            <th scope="col">Sr No.</th>
                            <th scope="col">Return No</th>
                            <th scope="col">Order No</th>
                            <th scope="col">Return Date</th>
                            <th scope="col">Reason</th>
                            <th scope="col">Return Status</th>
                            <th scope="col">Approval</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let returnItem of returnsList; let i = index">
                            <td>{{ (currentPage - 1) * itemsPerPage + i + 1 | number: '2.0' }}</td>
                            <td>{{ returnItem.returnNumber }}</td>
                            <td>{{ returnItem.orderId?.orderNumber }}</td>
                            <td>{{ returnItem.requestedAt | date: "dd-MM-yyyy"}}</td>
                            <td>{{ returnItem.returnReason ? returnItem.returnReason : "NA" }}</td>
                            
                            <!-- Return Status Column -->
                            <td>
                                <span [ngClass]="{
                                    'bg-secondary-focus text-secondary-main': returnItem.statusReturn === 'pendingReturn',
                                    'bg-warning-focus text-warning-main': returnItem.statusReturn === 'partiallyReturned',
                                    'bg-info-focus text-info-main': returnItem.statusReturn === 'fullyReturned'
                                }" class="px-24 py-4 rounded-pill fw-medium text-sm">
                                    {{ returnItem.statusReturn | titlecase }}
                                </span>
                            </td>
                            
                            <!-- Approval Column - Shows buttons when pending approval -->
                            <td>
                                <!-- If pending approval, show approve/reject buttons -->
                                <div *ngIf="returnItem.statusApproval === 'pendingApproval'">
                                    <div class="d-flex flex-column gap-1">
                                        <!-- Show appropriate approve button -->
                                        <div class="d-flex gap-1">
                                            <!-- Approve Full button - always shown for pending approval -->
                                            <button (click)="approveReturn(returnItem._id)" 
                                                    class="btn btn-success btn-sm flex-grow-1"
                                                    [disabled]="isUpdating">
                                                <span *ngIf="isUpdating" class="spinner-border spinner-border-sm me-1"></span>
                                                {{ isUpdating ? 'Processing...' : 'Approve' }}
                                            </button>
                                            
                                            <!-- Approve Partial button - optional, shown next to Approve -->
                                            <button (click)="approvePartialReturn(returnItem._id)" 
                                                    class="btn btn-warning btn-sm flex-grow-1"
                                                    [disabled]="isUpdating">
                                                {{ isUpdating ? 'Processing...' : 'Approve Partial' }}
                                            </button>
                                        </div>
                                        
                                        <!-- Reject Button -->
                                        <button type="button" 
                                                class="btn btn-danger btn-sm"
                                                data-bs-toggle="modal" 
                                                [attr.data-bs-target]="'#rejectModal' + returnItem._id"
                                                [disabled]="isUpdating">
                                            {{ isUpdating ? 'Processing...' : 'Reject' }}
                                        </button>
                                    </div>
                                    
                                    <!-- Rejection Reason Modal -->
                                    <div class="modal fade" [id]="'rejectModal' + returnItem._id" tabindex="-1">
                                        <div class="modal-dialog modal-sm">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Reject Return</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>Are you sure you want to reject this return request?</p>
                                                    <div class="mb-3">
                                                        <label class="form-label">Rejection Reason (Optional)</label>
                                                        <textarea [(ngModel)]="rejectionReason" 
                                                                class="form-control" 
                                                                rows="3"
                                                                placeholder="Enter reason for rejection..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="button" class="btn btn-danger" 
                                                            data-bs-dismiss="modal"
                                                            (click)="rejectReturn(returnItem._id)">
                                                        Reject
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- If approval decision has been made, show status badge -->
                                <div *ngIf="returnItem.statusApproval !== 'pendingApproval'">
                                    <span [ngClass]="{
                                        'bg-success-focus text-success-main': returnItem.statusApproval === 'approved',
                                        'bg-danger-focus text-danger-main': returnItem.statusApproval === 'rejected',
                                        'bg-warning-focus text-warning-main': returnItem.statusApproval === 'partiallyApproved'
                                    }" class="px-24 py-4 rounded-pill fw-medium text-sm">
                                        {{ returnItem.statusApproval | titlecase }}
                                    </span>
                                    <div *ngIf="returnItem.statusApproval === 'approved'" class="text-success small mt-1">
                                        ✓ Request approved
                                    </div>
                                    <div *ngIf="returnItem.statusApproval === 'rejected'" class="text-danger small mt-1">
                                        ✗ Request rejected
                                    </div>
                                    <div *ngIf="returnItem.statusApproval === 'partiallyApproved'" class="text-warning small mt-1">
                                        ⚠ Partial approval
                                    </div>
                                </div>
                            </td>
                            
                            <!-- Actions Column - Only view and delete buttons -->
                            <td>
                                <div class="d-flex align-items-center justify-content-end gap-1 w-100">
                                    <!-- View Button -->
                                    <a style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#viewReturnModal" 
                                       (click)="openReturnDetails(returnItem)"
                                       class="w-32-px h-32-px bg-primary-light text-primary-600 rounded-circle d-inline-flex align-items-center justify-content-center">
                                        <iconify-icon icon="iconamoon:eye-light"></iconify-icon>
                                    </a>
                                    
                                    <!-- Delete button (only for pending return) -->
                                    <a *ngIf="returnItem.statusReturn == 'pendingReturn' && returnItem.statusApproval == 'pendingApproval'" 
                                       href="javascript:void(0)"
                                       class="w-32-px h-32-px bg-danger-focus text-danger-main rounded-circle d-inline-flex align-items-center justify-content-center">
                                        <iconify-icon icon="mingcute:delete-2-line"></iconify-icon>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- View Modal (Keep your existing view modal, but update status display) -->
<div class="modal fade" id="viewReturnModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Return Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="selectedReturn">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6 class="mb-2">Return Number: <strong>{{ selectedReturn.returnNumber }}</strong></h6>
            <p class="text-muted mb-2"><strong>Event:</strong> {{ selectedReturn.eventId?.eventName || 'N/A' }}</p>
            <p class="text-muted mb-2"><strong>Order:</strong> {{ selectedReturn.orderId?.orderNumber }}</p>
          </div>
          <div class="col-md-6">
            <p class="text-muted mb-2">
              <strong>Return Status:</strong> 
              <span [ngClass]="{
                'text-secondary': selectedReturn.statusReturn === 'pendingReturn',
                'text-warning': selectedReturn.statusReturn === 'partiallyReturned',
                'text-info': selectedReturn.statusReturn === 'fullyReturned'
              }">
                {{ selectedReturn.statusReturn | titlecase }}
              </span>
            </p>
            <p class="text-muted mb-2">
              <strong>Approval Status:</strong> 
              <span [ngClass]="{
                'text-success': selectedReturn.statusApproval === 'approved',
                'text-danger': selectedReturn.statusApproval === 'rejected',
                'text-warning': selectedReturn.statusApproval === 'partiallyApproved',
                'text-secondary': selectedReturn.statusApproval === 'pendingApproval'
              }">
                {{ selectedReturn.statusApproval | titlecase }}
              </span>
            </p>
            <p class="text-muted mb-2" *ngIf="selectedReturn.rejectionReason">
              <strong>Rejection Reason:</strong> {{ selectedReturn.rejectionReason }}
            </p>
          </div>
        </div>

        <p class="text-muted mb-2"><strong>Return Reason:</strong> {{ selectedReturn.returnReason || 'N/A' }}</p>
        <p class="text-muted mb-3"><strong>Notes:</strong> {{ selectedReturn.notes || 'N/A' }}</p>

        <hr>

        <!-- Return Summary -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h5 class="mb-0">{{ selectedReturn.totalReturned || 0 }}</h5>
                <small class="text-muted">Total Returned</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h5 class="mb-0">{{ selectedReturn.totalPending || 0 }}</h5>
                <small class="text-muted">Total Pending</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h5 class="mb-0">{{ selectedReturn.totalLost || 0 }}</h5>
                <small class="text-muted">Total Lost</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h5 class="mb-0">{{ selectedReturn.completionPercentage || 0 }}%</h5>
                <small class="text-muted">Completion</small>
              </div>
            </div>
          </div>
        </div>

        <!-- ITEMS TABLE -->
        <h6 class="mb-3">Returned Items</h6>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Product</th>
              <th>SKU</th>
              <th>Returned</th>
              <th>Pending</th>
              <th>Lost</th>
              <th>Condition</th>
              <th>Loss Reason</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of selectedReturn.items">
              <td>{{ item.productId?.name }}</td>
              <td>{{ item.productId?.SKU || 'N/A' }}</td>
              <td>{{ item.quantityReturned }}</td>
              <td>{{ item.quantityPending || 0 }}</td>
              <td>{{ item.quantityLost || 0 }}</td>
              <td>{{ item.condition | titlecase }}</td>
              <td>{{ item.lossReason || 'N/A' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>